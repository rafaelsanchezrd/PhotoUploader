name: Build SnapFlow

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  APP_NAME: SnapFlow

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Debug - List repository contents
      shell: pwsh
      run: |
        Write-Host "=== Current Directory ==="
        Get-Location
        Write-Host "`n=== Root Files ==="
        Get-ChildItem | Format-Table Name, Length
        Write-Host "`n=== Checking for main.py ==="
        if (Test-Path "main.py") {
          Write-Host "âœ“ Found main.py in root"
        } else {
          Write-Host "âœ— main.py NOT in root"
          Write-Host "`nSearching for main.py..."
          Get-ChildItem -Recurse -Filter "main.py" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Found at: $($_.FullName)" }
        }
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Verify files before build
      shell: pwsh
      run: |
        Write-Host "Checking required files..."
        $files = @("main.py", "config.py", "requirements.txt", "uploadericon.png", "version_info.txt")
        foreach ($file in $files) {
          if (Test-Path $file) {
            Write-Host "âœ“ $file"
          } else {
            Write-Host "âœ— $file MISSING"
          }
        }
    
    - name: Build Windows executable
      shell: pwsh
      run: |
        if (-not (Test-Path "main.py")) {
          Write-Host "ERROR: main.py not found in current directory!"
          Write-Host "Current location: $(Get-Location)"
          exit 1
        }
        
        pyinstaller --clean --onefile --windowed --name "${{ env.APP_NAME }}" `
          --icon=uploadericon.png `
          --hidden-import=tkinter `
          --hidden-import=cryptography `
          --hidden-import=cryptography.fernet `
          --hidden-import=dropbox `
          --hidden-import=requests `
          --hidden-import=urllib3 `
          --hidden-import=certifi `
          --exclude-module=pytest `
          --exclude-module=setuptools `
          --exclude-module=pip `
          --noupx `
          --version-file=version_info.txt `
          main.py
    
    - name: Verify build output
      shell: pwsh
      run: |
        if (Test-Path "dist/${{ env.APP_NAME }}.exe") {
          Write-Host "âœ“ Build successful: dist/${{ env.APP_NAME }}.exe"
          $size = (Get-Item "dist/${{ env.APP_NAME }}.exe").Length / 1MB
          Write-Host "Size: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "âœ— Build failed - exe not found"
          exit 1
        }
    
    - name: Calculate SHA256 hash
      shell: pwsh
      run: |
        $hash = (Get-FileHash "dist\${{ env.APP_NAME }}.exe" -Algorithm SHA256).Hash
        $hash | Out-File "dist\${{ env.APP_NAME }}.exe.sha256" -Encoding ASCII
        Write-Host "SHA256: $hash"
        Write-Host "WINDOWS_SHA256=$hash" >> $env:GITHUB_ENV
    
    - name: Create distribution info
      shell: pwsh
      run: |
        @"
        # SnapFlow - Windows Build
        
        **Version**: ${{ github.ref_name }}
        **Built**: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
        **Commit**: ${{ github.sha }}
        
        ## Files
        - SnapFlow.exe
        - SnapFlow.exe.sha256
        
        ## SHA256 Hash
        ``````
        $env:WINDOWS_SHA256
        ``````
        
        ## Installation
        1. Download SnapFlow.exe
        2. Right-click â†’ Properties â†’ Check "Unblock" if present
        3. Run the executable
        
        ## Antivirus Warning?
        This is a FALSE POSITIVE (common with PyInstaller apps).
        - Click "More info" â†’ "Run anyway" in Windows Defender
        - Or check SHA256 hash matches above
        - Source code is available for verification
        
        See README for full instructions.
        "@ | Out-File "dist\README-Windows.md" -Encoding UTF8
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-Windows
        path: |
          dist/${{ env.APP_NAME }}.exe
          dist/${{ env.APP_NAME }}.exe.sha256
          dist/README-Windows.md
        retention-days: 90
    
    - name: Upload to Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/${{ env.APP_NAME }}.exe
          dist/${{ env.APP_NAME }}.exe.sha256
          dist/README-Windows.md
        fail_on_unmatched_files: false

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Debug - List repository contents
      run: |
        echo "=== Current Directory ==="
        pwd
        echo ""
        echo "=== Root Files ==="
        ls -la
        echo ""
        echo "=== Checking for main.py ==="
        if [ -f "main.py" ]; then
          echo "âœ“ Found main.py in root"
        else
          echo "âœ— main.py NOT in root"
          echo ""
          echo "Searching for main.py..."
          find . -name "main.py" -type f 2>/dev/null || echo "Not found anywhere"
        fi
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Install create-dmg
      run: |
        brew install create-dmg
    
    - name: Verify files before build
      run: |
        echo "Checking required files..."
        for file in main.py config.py requirements.txt uploadericon.png; do
          if [ -f "$file" ]; then
            echo "âœ“ $file"
          else
            echo "âœ— $file MISSING"
          fi
        done
    
    - name: Build macOS application
      run: |
        if [ ! -f "main.py" ]; then
          echo "ERROR: main.py not found in current directory!"
          echo "Current location: $(pwd)"
          exit 1
        fi
        
        pyinstaller --clean --onefile --windowed --name "${{ env.APP_NAME }}" \
          --icon=uploadericon.png \
          --hidden-import=cryptography \
          --hidden-import=cryptography.fernet \
          --hidden-import=dropbox \
          --hidden-import=requests \
          --hidden-import=urllib3 \
          --hidden-import=certifi \
          --exclude-module=pytest \
          --exclude-module=setuptools \
          --exclude-module=pip \
          --osx-bundle-identifier "com.snapflow.app" \
          main.py
    
    - name: Verify build output
      run: |
        if [ -d "dist/${{ env.APP_NAME }}.app" ]; then
          echo "âœ“ Build successful: dist/${{ env.APP_NAME }}.app"
          du -sh "dist/${{ env.APP_NAME }}.app"
        else
          echo "âœ— Build failed - .app not found"
          exit 1
        fi
    
    - name: Set permissions
      run: |
        chmod +x "dist/${{ env.APP_NAME }}.app/Contents/MacOS/${{ env.APP_NAME }}"
    
    - name: Create DMG
      run: |
        echo "Creating DMG installer..."
        
        # Try fancy DMG with background first
        if [ -f "_dmgbackground.png" ]; then
          echo "Found background image, creating fancy DMG..."
          create-dmg \
            --volname "SnapFlow" \
            --volicon "uploadericon.png" \
            --background "_dmgbackground.png" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "${{ env.APP_NAME }}.app" 175 190 \
            --hide-extension "${{ env.APP_NAME }}.app" \
            --app-drop-link 425 190 \
            --format UDZO \
            "dist/${{ env.APP_NAME }}.dmg" \
            "dist/${{ env.APP_NAME }}.app" \
            && echo "âœ“ Fancy DMG created" \
            || {
              echo "âš  Fancy DMG failed, trying simple DMG..."
              rm -f "dist/${{ env.APP_NAME }}.dmg"
              mkdir -p dist/dmg_temp
              cp -R "dist/${{ env.APP_NAME }}.app" dist/dmg_temp/
              ln -s /Applications dist/dmg_temp/Applications
              hdiutil create -volname "SnapFlow" \
                -srcfolder dist/dmg_temp \
                -ov -format UDZO \
                "dist/${{ env.APP_NAME }}.dmg"
              rm -rf dist/dmg_temp
              echo "âœ“ Simple DMG created"
            }
        else
          echo "No background image, creating simple DMG..."
          mkdir -p dist/dmg_temp
          cp -R "dist/${{ env.APP_NAME }}.app" dist/dmg_temp/
          ln -s /Applications dist/dmg_temp/Applications
          hdiutil create -volname "SnapFlow" \
            -srcfolder dist/dmg_temp \
            -ov -format UDZO \
            "dist/${{ env.APP_NAME }}.dmg"
          rm -rf dist/dmg_temp
          echo "âœ“ Simple DMG created"
        fi
    
    - name: Verify DMG
      run: |
        if [ -f "dist/${{ env.APP_NAME }}.dmg" ]; then
          echo "âœ“ DMG created successfully"
          ls -lh "dist/${{ env.APP_NAME }}.dmg"
        else
          echo "âœ— DMG creation failed"
          exit 1
        fi
    
    - name: Calculate SHA256 hash
      run: |
        cd dist
        shasum -a 256 "${{ env.APP_NAME }}.dmg" > "${{ env.APP_NAME }}.dmg.sha256"
        cat "${{ env.APP_NAME }}.dmg.sha256"
        echo "MACOS_SHA256=$(cat ${{ env.APP_NAME }}.dmg.sha256 | awk '{print $1}')" >> $GITHUB_ENV
    
    - name: Create distribution info
      run: |
        cat > "dist/README-macOS.md" << 'EOF'
        # SnapFlow - macOS Build
        
        **Version**: ${{ github.ref_name }}
        **Built**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **Commit**: ${{ github.sha }}
        
        ## Files
        - SnapFlow.dmg (DMG installer)
        - SnapFlow.dmg.sha256 (verification hash)
        
        ## SHA256 Hash
        ```
        ${{ env.MACOS_SHA256 }}
        ```
        
        ## Installation
        1. Download SnapFlow.dmg
        2. Open the DMG file
        3. Drag SnapFlow.app to Applications folder
        4. **First run only**: Right-click â†’ Open (bypasses Gatekeeper)
        5. Click "Open" in the security dialog
        
        ## Gatekeeper Warning?
        This app is NOT code-signed yet (working on it!).
        - **Safe to use**: Source code is fully available
        - **Verification**: Check SHA256 hash matches above
        - Right-click â†’ Open to bypass the warning
        
        ## Future: Code Signing
        We're working on getting an Apple Developer certificate
        to eliminate security warnings. This requires a $99/year
        Apple Developer Program membership.
        
        See README for full instructions.
        EOF
    
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-macOS
        path: |
          dist/${{ env.APP_NAME }}.dmg
          dist/${{ env.APP_NAME }}.dmg.sha256
          dist/README-macOS.md
        retention-days: 90
    
    - name: Upload to Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/${{ env.APP_NAME }}.dmg
          dist/${{ env.APP_NAME }}.dmg.sha256
          dist/README-macOS.md
        fail_on_unmatched_files: false

  create-release-notes:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Create Release Notes
      run: |
        cat > RELEASE_NOTES.md << 'EOF'
        ## ðŸ“¸ SnapFlow ${{ github.ref_name }}
        
        Desktop application for photographers to upload photos to Dropbox via Make.com workflow.
        
        ### ðŸ“¦ Downloads
        
        | Platform | File | SHA256 |
        |----------|------|--------|
        | Windows | SnapFlow.exe | See .sha256 file |
        | macOS | SnapFlow.dmg | See .sha256 file |
        
        ### ðŸªŸ Windows Installation
        
        1. Download `SnapFlow.exe`
        2. Download `SnapFlow.exe.sha256` (optional - for verification)
        3. Right-click exe â†’ Properties â†’ Check "Unblock" if present
        4. Run the application
        
        **âš ï¸ Antivirus Warning?**
        - This is a FALSE POSITIVE (common with PyInstaller)
        - Click "More info" â†’ "Run anyway" in Windows Defender
        - Or verify the SHA256 hash matches the .sha256 file
        - Source code is fully available on GitHub for inspection
        
        ### ðŸŽ macOS Installation
        
        1. Download `SnapFlow.dmg`
        2. Download `SnapFlow.dmg.sha256` (optional - for verification)
        3. Open the DMG file
        4. Drag SnapFlow.app to Applications
        5. **First run**: Right-click â†’ Open (bypasses Gatekeeper)
        
        **âš ï¸ Gatekeeper Warning?**
        - App is not code-signed yet (requires $99/year Apple Developer Program)
        - Right-click â†’ Open on first launch
        - Or verify SHA256 hash
        - Source code available for inspection
        
        ### ðŸ” Security Notes
        
        - All builds are reproducible from source
        - SHA256 hashes provided for verification
        - Antivirus warnings are false positives
        - We're working on code signing certificates
        
        ### ðŸ“š Documentation
        
        See the README for:
        - Full setup instructions
        - Configuration guide
        - Troubleshooting
        
        ---
        
        **Need help?** Open an issue on GitHub or check the documentation.
        EOF
    
    - name: Update Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: RELEASE_NOTES.md
        fail_on_unmatched_files: false